<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absen AF PRODUCTIONS</title>
  <style>
    :root {
      --primary: #0d6efd;
      --danger: #dc3545;
      --gray: #f8f9fa;
      --dark: #212529;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--gray);
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 600px;
      margin: 2rem auto;
      background: white;
      border-radius: 10px;
      padding: 2rem;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    .hidden { display: none; }

    h2, h3 { color: var(--primary); }

    input, button, select {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      background: var(--primary);
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }

    button:hover { background: #0b5ed7; }

    #btnPulang { background-color: var(--danger); }
    #btnPulang:hover { background-color: #b02a37; }

    video {
      width: 100%;
      border-radius: 10px;
      transform: scaleX(-1); /* Normal (non-mirror) */
    }

    .riwayat-item {
      background: var(--gray);
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-left: 4px solid var(--primary);
      font-size: 0.9rem;
      border-radius: 4px;
    }

    .admin-section {
      margin-top: 2rem;
      border-top: 2px dashed var(--primary);
      padding-top: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }

    th {
      background: var(--primary);
      color: white;
    }
  </style>
</head>
<body>

<div class="container" id="loginPage">
  <h2>Login Absen</h2>
  <input type="text" id="loginNoInduk" placeholder="üÜî Nama">
  <input type="password" id="loginPassword" placeholder="üîí Password">
  <button id="btnLogin">Masuk</button>
</div>

<div class="container hidden" id="absenPage">
  <h2>ABSEN AF PRODUCTIONS</h2>
  <div id="liveTime"></div>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <button id="btnMasuk">‚úÖ Absen Masuk</button>
  <button id="btnPulang">‚èπÔ∏è Absen Pulang</button>
  <div id="riwayat"></div>

  <div class="admin-section" id="adminPanel" style="display: none;">
    <h3>üìä Statistik Kehadiran</h3>
    <div id="chartStats"></div>
    <h3>üë• Manajemen User</h3>
    <table id="userTable">
      <thead><tr><th>Nama</th><th>Password</th><th>Reset</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbxIt5rLjpI9hreKfaa6YtolBaGAHQwD06oxKb0NllISpksNW_sXtGshLI3pJykJtTXr/exec";

const loginPage = document.getElementById('loginPage');
const absenPage = document.getElementById('absenPage');
const adminPanel = document.getElementById('adminPanel');
const btnLogin = document.getElementById('btnLogin');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const riwayatEl = document.getElementById('riwayat');
const liveTimeEl = document.getElementById('liveTime');

let user = null;
let pass = null;

// Tampilkan waktu realtime
setInterval(() => {
  liveTimeEl.textContent = new Date().toLocaleString();
}, 1000);

// Kamera non-mirror
function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => video.srcObject = stream)
    .catch(() => alert("Gagal akses kamera!"));
}

btnLogin.addEventListener('click', () => {
  const nama = document.getElementById('loginNoInduk').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  if (!nama || !password) return alert("‚ùå Nama & Password wajib diisi.");

  localStorage.setItem('noInduk', nama);
  localStorage.setItem('password', password);
  user = nama;
  pass = password;

  loginPage.classList.add('hidden');
  absenPage.classList.remove('hidden');
  startCamera();
  tampilkanRiwayat();
  cekAdmin();
});

window.onload = () => {
  const storedUser = localStorage.getItem('noInduk');
  const storedPass = localStorage.getItem('password');
  if (storedUser && storedPass) {
    user = storedUser;
    pass = storedPass;
    loginPage.classList.add('hidden');
    absenPage.classList.remove('hidden');
    startCamera();
    tampilkanRiwayat();
    cekAdmin();
  }
};

async function absen(tipe) {
  if (!user || !pass) return alert("Harap login dulu.");
  navigator.geolocation.getCurrentPosition(async position => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    const selfie = canvas.toDataURL("image/jpeg");

    const data = {
      type: "absen", user, pass, tipe,
      lat: position.coords.latitude,
      lng: position.coords.longitude,
      selfie
    };

    const res = await fetch(apiUrl, {
      method: "POST",
      body: JSON.stringify(data),
      headers: { "Content-Type": "application/json" }
    });

    const json = await res.json();
    if (json.status === "success") {
      alert(tipe === "masuk" ? "‚úÖ Selamat bekerja!" : "‚úÖ Sampai jumpa!");
      simpanRiwayat(tipe, data.lat, data.lng);
      tampilkanRiwayat();
    } else {
      alert("‚ùå Gagal absen: " + json.message);
    }
  }, () => alert("‚ùå Lokasi tidak bisa diakses."));
}

document.getElementById('btnMasuk').onclick = () => absen("masuk");
document.getElementById('btnPulang').onclick = () => absen("pulang");

function simpanRiwayat(tipe, lat, lng) {
  const now = new Date().toISOString();
  let riwayat = JSON.parse(localStorage.getItem('riwayatAbsen') || '[]');
  riwayat.push({ tipe, lat, lng, waktu: now });
  localStorage.setItem('riwayatAbsen', JSON.stringify(riwayat));
}

function tampilkanRiwayat() {
  let riwayat = JSON.parse(localStorage.getItem('riwayatAbsen') || '[]');
  riwayatEl.innerHTML = "<h3>Riwayat Absen</h3>";
  if (riwayat.length === 0) return riwayatEl.innerHTML += "<p>Belum ada data.</p>";
  riwayat.slice(-10).reverse().forEach(item => {
    riwayatEl.innerHTML += `
      <div class="riwayat-item">
        <strong>${item.tipe.toUpperCase()}</strong><br>
        Waktu: ${new Date(item.waktu).toLocaleString()}<br>
        Lokasi: (${item.lat.toFixed(4)}, ${item.lng.toFixed(4)})
      </div>`;
  });
}

async function cekAdmin() {
  if (user.toLowerCase() === "admin") {
    adminPanel.style.display = "block";
    await tampilkanStats();
    await tampilkanUsers();
  }
}

async function tampilkanStats() {
  const res = await fetch(`${apiUrl}?type=stats`);
  const json = await res.json();
  const chartEl = document.getElementById('chartStats');
  chartEl.innerHTML = "";
  json.stats.forEach(item => {
    chartEl.innerHTML += `<div>üìÖ ${item.tanggal} ‚Äî ${item.jumlah} absen</div>`;
  });
}

async function tampilkanUsers() {
  const res = await fetch(`${apiUrl}?type=userList`);
  const json = await res.json();
  const tbody = document.querySelector("#userTable tbody");
  tbody.innerHTML = "";
  json.users.forEach(user => {
    tbody.innerHTML += `
      <tr>
        <td>${user.user}</td>
        <td>${user.password}</td>
        <td><button onclick="resetPassword('${user.user}')">Reset</button></td>
      </tr>`;
  });
}

async function resetPassword(nama) {
  if (!confirm(`Reset password untuk ${nama} ke "123456"?`)) return;
  const res = await fetch(`${apiUrl}?type=resetPassword&user=${encodeURIComponent(nama)}`);
  const json = await res.json();
  alert(json.message || "Selesai");
  await tampilkanUsers();
}
</script>

</body>
</html>
