<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absen AF PRODUCTIONS</title>
  <style>
    :root {
      --primary: #0d6efd;
      --danger: #dc3545;
      --gray: #f8f9fa;
      --dark: #212529;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--gray);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      background: white;
      max-width: 600px;
      width: 100%;
      border-radius: 10px;
      padding: 2rem;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    .hidden { display: none; }

    #loginPage h2 {
      color: var(--primary);
      text-align: center;
      margin-bottom: 1.5rem;
    }

    #loginPage input, #loginPage button {
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 6px;
    }

    #loginPage input {
      border: 1px solid #ccc;
    }

    #loginPage button {
      background: var(--primary);
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }

    #loginPage button:hover {
      background: #0b5ed7;
    }

    #absenPage header {
      background: var(--primary);
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      border-radius: 10px 10px 0 0;
      margin: -2rem -2rem 1rem -2rem;
    }

    #liveTime {
      text-align: center;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    #video {
      width: 100%;
      transform: scaleX(-1); /* Tidak miror */
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    #absenPage button {
      padding: 0.75rem;
      width: 100%;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      color: white;
      margin-top: 0.5rem;
    }

    #btnMasuk { background-color: var(--primary); }
    #btnMasuk:hover { background-color: #0b5ed7; }

    #btnPulang { background-color: var(--danger); }
    #btnPulang:hover { background-color: #b02a37; }

    .riwayat-item {
      background: var(--gray);
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-left: 4px solid var(--primary);
      font-size: 0.9rem;
      border-radius: 4px;
    }

    #adminPanel {
      margin-top: 2rem;
      background: #f1f1f1;
      padding: 1rem;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="container">
    <h2>Login Absen</h2>
    <input type="text" id="loginNoInduk" placeholder="üÜî Nama" />
    <input type="password" id="loginPassword" placeholder="üîí Password" />
    <button id="btnLogin">Masuk</button>
  </div>

  <!-- ABSEN PAGE -->
  <div id="absenPage" class="container hidden">
    <header>ABSEN AF PRODUCTIONS</header>
    <div id="liveTime"></div>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <button id="btnMasuk">‚úÖ Absen Masuk</button>
    <button id="btnPulang">‚èπÔ∏è Absen Pulang</button>

    <div id="riwayat"></div>

    <div id="adminPanel" class="hidden">
      <h3>Panel Admin</h3>
      <p>üìä Statistik dan fitur admin akan ditampilkan di sini.</p>
    </div>
  </div>

<script>
  const apiUrl = "https://script.google.com/macros/s/YOUR_API_URL/exec";

  const loginPage = document.getElementById('loginPage');
  const absenPage = document.getElementById('absenPage');
  const btnLogin = document.getElementById('btnLogin');
  const liveTimeEl = document.getElementById('liveTime');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const riwayatEl = document.getElementById('riwayat');
  const btnMasuk = document.getElementById('btnMasuk');
  const btnPulang = document.getElementById('btnPulang');
  const adminPanel = document.getElementById('adminPanel');

  let user = null;
  let pass = null;

  setInterval(() => {
    const now = new Date();
    liveTimeEl.textContent = now.toLocaleString();
  }, 1000);

  btnLogin.addEventListener('click', () => {
    const noInduk = document.getElementById('loginNoInduk').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    if (!noInduk || !password) {
      alert('‚ùå Harap isi Nama dan Password.');
      return;
    }

    user = noInduk;
    pass = password;

    loginPage.classList.add('hidden');
    absenPage.classList.remove('hidden');

    startCamera();
    tampilkanRiwayat();
    cekAdmin();
  });

  function startCamera() {
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
        })
        .catch(() => {
          alert('Gagal mengakses kamera. Pastikan izin kamera diberikan.');
        });
    } else {
      alert('Browser tidak mendukung kamera.');
    }
  }

  function simpanRiwayat(tipe, lat, lng) {
    const now = new Date().toISOString();
    let data = localStorage.getItem('riwayatAbsen');
    let riwayat = data ? JSON.parse(data) : [];
    riwayat.push({ tipe, lat, lng, waktu: now });
    localStorage.setItem('riwayatAbsen', JSON.stringify(riwayat));
  }

  function tampilkanRiwayat() {
    let data = localStorage.getItem('riwayatAbsen');
    let riwayat = data ? JSON.parse(data) : [];
    riwayatEl.innerHTML = "<h3>Riwayat Absen</h3>";
    if (riwayat.length === 0) {
      riwayatEl.innerHTML += "<p>Belum ada riwayat absen.</p>";
      return;
    }

    riwayat.slice(-10).reverse().forEach(item => {
      riwayatEl.innerHTML += `
        <div class="riwayat-item">
          <strong>${item.tipe.toUpperCase()}</strong><br>
          Waktu: ${new Date(item.waktu).toLocaleString()}<br>
          Lokasi: (${item.lat.toFixed(4)}, ${item.lng.toFixed(4)})
        </div>
      `;
    });
  }

  async function absen(tipe) {
    if (!user || !pass) {
      alert("Harap login terlebih dahulu.");
      return;
    }

    navigator.geolocation.getCurrentPosition(async position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const selfie = canvas.toDataURL("image/jpeg");

      const data = {
        type: "absen",
        user,
        pass,
        tipe,
        lat,
        lng,
        selfie
      };

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          body: JSON.stringify(data),
          headers: { "Content-Type": "application/json" }
        });
        const resp = await res.json();

        if (resp.status === "success") {
          alert(tipe === "masuk" ? "‚úÖ Selamat bekerja!" : "‚úÖ Terima kasih!");
          simpanRiwayat(tipe, lat, lng);
          tampilkanRiwayat();
        } else {
          alert("‚ùå Gagal absen: " + resp.message);
        }
      } catch (e) {
        alert("‚ùå Gagal mengirim data ke server.");
      }
    }, () => {
      alert("‚ùå Gagal mendapatkan lokasi.");
    });
  }

  btnMasuk.addEventListener('click', () => absen("masuk"));
  btnPulang.addEventListener('click', () => absen("pulang"));

  function cekAdmin() {
    if (user.toLowerCase() === "admin") {
      adminPanel.classList.remove("hidden");
    } else {
      adminPanel.classList.add("hidden");
    }
  }

  window.onload = () => {
    // Nonaktifkan auto-login
    loginPage.classList.remove('hidden');
    absenPage.classList.add('hidden');
  };
</script>

</body>
</html>
