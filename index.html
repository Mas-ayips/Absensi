<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Absensi AF PRODUCTIONS</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Inter', sans-serif;
    background: #121212;
    color: #fff;
    margin: 0;
    padding: 0;
  }
  header {
    background: #000;
    padding: 1.5rem;
    text-align: center;
    color: #ffcc00;
    font-size: 1.8rem;
    font-weight: bold;
  }
  marquee {
    background: #ffcc00;
    color: #121212;
    padding: 10px;
    font-weight: bold;
  }
  main {
    max-width: 480px;
    margin: auto;
    padding: 2rem 1rem;
  }
  .card {
    background: #1f1f1f;
    border-radius: 14px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 0 10px rgba(255, 204, 0, 0.2);
  }
  h2 {
    color: #ffcc00;
    margin-bottom: 1rem;
  }
  input, button {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
  }
  input {
    background: #292929;
    color: white;
  }
  button {
    background: linear-gradient(to right, #ffcc00, #ff6600);
    color: #121212;
    font-weight: bold;
    cursor: pointer;
  }
  button:hover {
    transform: scale(1.03);
  }
  video {
    width: 100%;
    border-radius: 10px;
    margin-top: 1rem;
    transform: scaleX(-1);
  }
  .popup {
    position: fixed;
    top: 25%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #ffcc00;
    color: #000;
    padding: 1rem 2rem;
    border-radius: 10px;
    font-weight: 700;
    box-shadow: 0 0 20px #ff9900;
    display: none;
    z-index: 999;
  }

  /* Timeline Riwayat */
  .timeline {
    position: relative;
    padding-left: 20px;
    margin-top: 1rem;
    border-left: 3px solid #ffcc00;
  }
  .timeline-entry {
    margin-bottom: 1.2rem;
    padding-left: 10px;
  }
  .timeline-entry .waktu {
    font-size: 0.9rem;
    color: #bbb;
  }
  .timeline-entry .tipe {
    font-weight: bold;
    display: inline-block;
    margin-right: 10px;
  }
  .masuk {
    color: #00ff88;
  }
  .pulang {
    color: #ff6666;
  }
</style>
</head>
<body>

<marquee>üì¢ Silakan login & lakukan absen masuk/pulang. Utamakan keselamatan! üöß</marquee>
<header>AF PRODUCTIONS</header>

<main>
  <section class="card" id="login-section">
    <h2>üîê Login</h2>
    <input type="text" id="noInduk" placeholder="No Induk" />
    <input type="password" id="password" placeholder="Password" />
    <button id="loginBtn">Masuk</button>
  </section>

  <section class="card" id="absen-section" style="display:none;">
    <h2>üìç Absen</h2>
    <button id="btnMasuk">üü¢ Absen Masuk</button>
    <button id="btnPulang">üî¥ Absen Pulang</button>
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div class="timeline" id="historyList">
      <p>üìÑ Riwayat absen akan tampil di sini...</p>
    </div>
  </section>

  <section class="card" id="adminPanel" style="display:none;">
    <h2>üõ† Panel Admin IT</h2>
    <div id="adminData"></div>
  </section>
</main>

<div class="popup" id="popupMsg"></div>

<script>
const users = {
  "adminit": "admin123",
  ...Object.fromEntries([...Array(30)].map((_, i) => [`karyawan${String(i+1).padStart(2,'0')}`, "pass123"]))
};

let currentUser = null;
let historyData = [];

const loginBtn = document.getElementById("loginBtn");
const loginSection = document.getElementById("login-section");
const absenSection = document.getElementById("absen-section");
const adminPanel = document.getElementById("adminPanel");
const historyList = document.getElementById("historyList");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const popup = document.getElementById("popupMsg");

loginBtn.onclick = () => {
  const noInduk = document.getElementById("noInduk").value.trim();
  const password = document.getElementById("password").value;
  if (users[noInduk] === password) {
    currentUser = noInduk;
    loginSection.style.display = "none";
    absenSection.style.display = "block";
    if (noInduk === "adminit") {
      adminPanel.style.display = "block";
      loadAllData();
    }
    initCamera();
    loadHistory();
  } else {
    alert("Login gagal.");
  }
};

function initCamera() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
    .then(stream => video.srcObject = stream)
    .catch(() => alert("Kamera gagal diakses."));
}

function captureSelfie() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.translate(canvas.width, 0);
  ctx.scale(-1, 1);
  ctx.drawImage(video, 0, 0);
  return canvas.toDataURL("image/png");
}

function getLocation() {
  return new Promise((res, rej) => {
    navigator.geolocation.getCurrentPosition(
      pos => res({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
      err => rej(err)
    );
  });
}

function getToday() {
  return new Date().toISOString().split("T")[0];
}

function alreadyAbsen(tipe) {
  return historyData.some(d => d.tipe === tipe && d.waktu.startsWith(getToday()));
}

async function absen(tipe) {
  if (tipe === "Pulang" && !alreadyAbsen("Masuk")) {
    alert("Belum absen masuk hari ini.");
    return;
  }
  if (alreadyAbsen(tipe)) {
    alert(`Sudah absen ${tipe} hari ini.`);
    return;
  }
  const selfie = captureSelfie();
  let lokasi;
  try {
    lokasi = await getLocation();
  } catch {
    alert("Aktifkan GPS.");
    return;
  }
  const now = new Date();
  const data = {
    waktu: now.toISOString(),
    tipe,
    lokasi,
    selfie
  };
  historyData.unshift(data);
  saveHistory();
  renderHistory();

  popup.textContent = tipe === "Masuk" ? "‚úÖ Selamat bekerja dan utamakan keselamatan!" : "üëã Hati-hati di jalan. Terima kasih!";
  popup.style.display = "block";
  setTimeout(() => popup.style.display = "none", 4000);
}

function saveHistory() {
  localStorage.setItem("absen_" + currentUser, JSON.stringify(historyData));
}
function loadHistory() {
  const saved = localStorage.getItem("absen_" + currentUser);
  historyData = saved ? JSON.parse(saved) : [];
  renderHistory();
}
function renderHistory() {
  historyList.innerHTML = "";
  if (historyData.length === 0) {
    historyList.innerHTML = "<p>Tidak ada riwayat.</p>";
    return;
  }
  historyData.forEach(d => {
    const waktu = new Date(d.waktu);
    const entry = document.createElement("div");
    entry.className = "timeline-entry";
    entry.innerHTML = `<span class="tipe ${d.tipe.toLowerCase()}">[${d.tipe}]</span> <span class="waktu">${waktu.toLocaleString()}</span><br><small>üìç ${d.lokasi.lat.toFixed(4)}, ${d.lokasi.lng.toFixed(4)}</small>`;
    historyList.appendChild(entry);
  });
}
document.getElementById("btnMasuk").onclick = () => absen("Masuk");
document.getElementById("btnPulang").onclick = () => absen("Pulang");

function loadAllData() {
  let html = "<ul>";
  for (let key in localStorage) {
    if (key.startsWith("absen_")) {
      const user = key.replace("absen_", "");
      const data = JSON.parse(localStorage.getItem(key));
      data.forEach(d => {
        const waktu = new Date(d.waktu).toLocaleString();
        html += `<li><strong>${user}</strong> - [${d.tipe}] ${waktu} - Lokasi: ${d.lokasi.lat.toFixed(4)}, ${d.lokasi.lng.toFixed(4)}</li>`;
      });
    }
  }
  html += "</ul>";
  document.getElementById("adminData").innerHTML = html || "Tidak ada data.";
}
</script>
</body>
</html>
