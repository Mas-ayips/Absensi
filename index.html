<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absen AF PRODUCTIONS</title>
  <style>
    :root {
      --primary: #0d6efd;
      --danger: #dc3545;
      --gray: #f8f9fa;
      --dark: #212529;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--gray);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Container umum */
    .container {
      background: white;
      max-width: 600px;
      width: 100%;
      border-radius: 10px;
      padding: 2rem;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    /* Hiden page */
    .hidden {
      display: none;
    }

    /* Login page styles */
    #loginPage {
      text-align: center;
    }

    #loginPage h2 {
      color: var(--primary);
      margin-bottom: 1.5rem;
    }

    #loginPage input {
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    #loginPage button {
      width: 100%;
      padding: 0.75rem;
      margin-top: 1rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
    }

    #loginPage button:hover {
      background: #0b5ed7;
    }

    /* Absen page styles */
    #absenPage header {
      background: var(--primary);
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      border-radius: 10px 10px 0 0;
      margin: -2rem -2rem 1rem -2rem;
    }

    #liveTime {
      text-align: center;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    #absenPage video {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 1rem;
    }

    #absenPage button {
      padding: 0.75rem;
      width: 100%;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      color: white;
      margin-top: 0.5rem;
    }

    #btnMasuk {
      background-color: var(--primary);
    }

    #btnMasuk:hover {
      background-color: #0b5ed7;
    }

    #btnPulang {
      background-color: var(--danger);
    }

    #btnPulang:hover {
      background-color: #b02a37;
    }

    .riwayat-item {
      background: var(--gray);
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-left: 4px solid var(--primary);
      font-size: 0.9rem;
      border-radius: 4px;
    }

  </style>
</head>
<body>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="container">
    <h2>Login Absen</h2>
    <input type="text" id="loginNoInduk" placeholder="üÜî No Induk" />
    <input type="password" id="loginPassword" placeholder="üîí Password" />
    <button id="btnLogin">Masuk</button>
  </div>

  <!-- ABSEN PAGE -->
  <div id="absenPage" class="container hidden">
    <header>ABSEN AF PRODUCTIONS</header>
    <div id="liveTime"></div>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <button id="btnMasuk">‚úÖ Absen Masuk</button>
    <button id="btnPulang">‚èπÔ∏è Absen Pulang</button>

    <div id="riwayat"></div>
  </div>

<script>
  // API URL Google Apps Script backend
  const apiUrl = "https://script.google.com/macros/s/AKfycbxIt5rLjpI9hreKfaa6YtolBaGAHQwD06oxKb0NllISpksNW_sXtGshLI3pJykJtTXr/exec";

  // Elemen DOM
  const loginPage = document.getElementById('loginPage');
  const absenPage = document.getElementById('absenPage');
  const btnLogin = document.getElementById('btnLogin');
  const liveTimeEl = document.getElementById('liveTime');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const riwayatEl = document.getElementById('riwayat');
  const btnMasuk = document.getElementById('btnMasuk');
  const btnPulang = document.getElementById('btnPulang');

  // Status login & absen
  let user = null;
  let pass = null;

  // Tampilkan waktu realtime di absenPage
  function updateLiveTime() {
    const now = new Date();
    liveTimeEl.textContent = now.toLocaleString();
  }
  setInterval(updateLiveTime, 1000);

  // Login fungsi
  btnLogin.addEventListener('click', () => {
    const noInduk = document.getElementById('loginNoInduk').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    if (!noInduk || !password) {
      alert('‚ùå Harap isi No Induk dan Password.');
      return;
    }

    // Simpan ke localStorage
    localStorage.setItem('noInduk', noInduk);
    localStorage.setItem('password', password);

    user = noInduk;
    pass = password;

    // Switch ke halaman absen
    loginPage.classList.add('hidden');
    absenPage.classList.remove('hidden');

    startCamera();
    tampilkanRiwayat();
  });

  // Cek kalau sudah login dari localStorage waktu reload halaman
  window.onload = () => {
    const storedUser = localStorage.getItem('noInduk');
    const storedPass = localStorage.getItem('password');
    if (storedUser && storedPass) {
      user = storedUser;
      pass = storedPass;
      loginPage.classList.add('hidden');
      absenPage.classList.remove('hidden');
      startCamera();
      tampilkanRiwayat();
    }
  };

  // Start kamera
  function startCamera() {
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
        })
        .catch(() => {
          alert('Gagal mengakses kamera. Pastikan izin kamera diberikan.');
        });
    } else {
      alert('Browser Anda tidak mendukung kamera.');
    }
  }

  // Fungsi absen (masuk/pulang)
  function absen(tipe) {
    if (!user || !pass) {
      alert("Harap login dulu.");
      return;
    }

    navigator.geolocation.getCurrentPosition(position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      // Tangkap gambar selfie
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const selfieData = canvas.toDataURL("image/jpeg");

      const data = {
        type: "absen",
        user,
        pass,
        tipe,
        lat,
        lng,
        selfie: selfieData
      };

      fetch(apiUrl, {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(resp => {
        if (resp.status === "success") {
          alert(tipe === "masuk" ? "‚úÖ Selamat bekerja!" : "‚úÖ Terima kasih, sampai jumpa!");
          tampilkanRiwayat();
        } else {
          alert("‚ùå Gagal absen: " + resp.message);
        }
      })
      .catch(() => alert("Gagal mengirim data ke server."));
    }, () => {
      alert("Gagal mendapatkan lokasi. Pastikan GPS aktif dan izinkan akses lokasi.");
    });
  }

  btnMasuk.addEventListener('click', () => absen("masuk"));
  btnPulang.addEventListener('click', () => absen("pulang"));

  // Tampilkan riwayat absen (contoh dummy, bisa diganti fetch dari backend)
  function tampilkanRiwayat() {
    // Contoh static dummy data, sebaiknya ambil dari backend jika ada
    // Sekarang tampilkan data dari localStorage saja sebagai contoh
    const riwayatDataRaw = localStorage.getItem('riwayatAbsen');
    let riwayatData = riwayatDataRaw ? JSON.parse(riwayatDataRaw) : [];

    // Tambahkan fitur fetch riwayat dari backend jika ada

    riwayatEl.innerHTML = "<h3>Riwayat Absen</h3>";
    if (riwayatData.length === 0) {
      riwayatEl.innerHTML += "<p>Belum ada riwayat absen.</p>";
      return;
    }

    riwayatData.slice(-10).reverse().forEach(item => {
      riwayatEl.innerHTML += `
        <div class="riwayat-item">
          <strong>${item.tipe.toUpperCase()}</strong><br>
          Waktu: ${new Date(item.waktu).toLocaleString()}<br>
          Lokasi: (${item.lat.toFixed(4)}, ${item.lng.toFixed(4)})
        </div>
      `;
    });
  }

  // Simpan riwayat ke localStorage (tambahan untuk demo)
  // Dalam absen() sebenarnya harus simpan ke backend,
  // di sini kita juga simpan lokal agar bisa tampil riwayat
  function simpanRiwayat(tipe, lat, lng) {
    const now = new Date().toISOString();
    let riwayatDataRaw = localStorage.getItem('riwayatAbsen');
    let riwayatData = riwayatDataRaw ? JSON.parse(riwayatDataRaw) : [];
    riwayatData.push({ tipe, lat, lng, waktu: now });
    localStorage.setItem('riwayatAbsen', JSON.stringify(riwayatData));
  }

  // Modifikasi fungsi absen agar simpan riwayat lokal setelah sukses
  async function absen(tipe) {
    if (!user || !pass) {
      alert("Harap login dulu.");
      return;
    }

    navigator.geolocation.getCurrentPosition(async position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      // Tangkap gambar selfie
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const selfieData = canvas.toDataURL("image/jpeg");

      const data = {
        type: "absen",
        user,
        pass,
        tipe,
        lat,
        lng,
        selfie: selfieData
      };

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          body: JSON.stringify(data),
          headers: { "Content-Type": "application/json" }
        });
        const resp = await res.json();

        if (resp.status === "success") {
          alert(tipe === "masuk" ? "‚úÖ Selamat bekerja!" : "‚úÖ Terima kasih, sampai jumpa!");
          simpanRiwayat(tipe, lat, lng);
          tampilkanRiwayat();
        } else {
          alert("‚ùå Gagal absen: " + resp.message);
        }
      } catch(e) {
        alert("Gagal mengirim data ke server.");
      }
    }, () => {
      alert("Gagal mendapatkan lokasi. Pastikan GPS aktif dan izinkan akses lokasi.");
    });
  }
</script>

</body>
</html>
