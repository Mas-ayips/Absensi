<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absen AF PRODUCTIONS</title>
  <style>
    :root {
      --primary: #0d6efd;
      --success: #198754;
      --warning: #ffc107;
      --danger: #dc3545;
      --gray: #f8f9fa;
      --dark: #212529;
      --bg-light: #f8f9fa;
      --text-light: #212529;
    }

    /* Reset dan font */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-light);
      color: var(--text-light);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    header {
      background-color: var(--primary);
      color: white;
      text-align: center;
      padding: 1.5rem;
      font-size: 1.8rem;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      position: relative;
      user-select: none;
    }

    .marquee-container {
      overflow: hidden;
      background: var(--warning);
      color: #212529;
      padding: 0.5rem 1rem;
      font-weight: 600;
      user-select: none;
      box-shadow: inset 0 2px 4px rgb(0 0 0 / 0.1);
    }

    .marquee {
      display: inline-block;
      white-space: nowrap;
      animation: scroll-left 18s linear infinite;
      font-size: 1.1rem;
    }

    @keyframes scroll-left {
      0% {
        transform: translateX(100%);
      }
      100% {
        transform: translateX(-100%);
      }
    }

    main.container, main.admin-container {
      max-width: 600px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      transition: background-color 0.4s, color 0.4s;
    }

    input, textarea, button, select {
      width: 100%;
      margin-top: 1rem;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      transition: border-color 0.3s;
      font-family: inherit;
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--primary);
      outline: none;
      background-color: #fff;
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.3s;
      user-select: none;
    }
    button:hover {
      background-color: #0b5ed7;
    }

    button.danger {
      background-color: var(--danger);
    }
    button.danger:hover {
      background-color: #a71d2a;
    }

    .riwayat, .chat {
      margin-top: 2rem;
    }

    .riwayat h3, .chat h3, .admin-section h3 {
      margin-bottom: 1rem;
      color: var(--primary);
      user-select: none;
    }

    .riwayat-item, .user-item {
      background: var(--gray);
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-left: 4px solid var(--primary);
      border-radius: 4px;
      font-size: 0.95rem;
      color: var(--dark);
      user-select: text;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-item button {
      width: auto;
      padding: 0.3rem 0.6rem;
      font-size: 0.85rem;
      margin-left: 0.5rem;
    }

    .chat textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* Kamera container */
    #cameraContainer {
      margin-top: 1rem;
      text-align: center;
    }

    video {
      width: 100%;
      max-width: 300px;
      border-radius: 10px;
      border: 2px solid var(--primary);
      transform: scaleX(1); /* normal (no mirror) */
      user-select: none;
      background: black;
    }

    footer {
      text-align: center;
      padding: 1rem;
      font-size: 0.85rem;
      color: var(--gray);
      user-select: none;
      background-color: var(--primary);
      color: white;
      margin-top: auto;
    }

    /* Login form */
    #loginPage {
      max-width: 400px;
      margin: 4rem auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    #loginPage h2 {
      margin-bottom: 1rem;
      text-align: center;
      color: var(--primary);
      user-select: none;
    }

    /* Tanggal & Waktu */
    #liveDateTime {
      text-align: center;
      margin-top: 1rem;
      font-weight: 600;
      user-select: none;
    }

    /* Logout button */
    #btnLogout {
      margin-top: 1rem;
      background-color: #555;
    }
    #btnLogout:hover {
      background-color: #333;
    }

    /* Admin Panel */
    .admin-section {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 2px solid var(--primary);
    }

    .admin-section form {
      max-width: 400px;
    }

    /* Responsive */
    @media (max-width: 600px) {
      main.container, main.admin-container {
        margin: 1rem;
        padding: 1.5rem;
      }

      #loginPage {
        margin: 2rem 1rem;
      }

      header {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>

  <header>ABSEN AF PRODUCTIONS</header>
  <div class="marquee-container">
    <div class="marquee">Keselamatan lebih ditentukan dan diukur dengan ketakhadirannya daripada kehadirannya | Pada akhirnya, tujuannya sederhana: keselamatan dan keamanan</div>
  </div>

  <div id="liveDateTime"></div>

  <!-- Halaman Login -->
  <div id="loginPage">
    <h2>Login Absen</h2>
    <form id="loginForm">
      <input type="text" id="username" placeholder="üÜî Username" required autocomplete="username" />
      <input type="password" id="userpass" placeholder="üîí Password" required autocomplete="current-password" />
      <button type="submit">Login</button>
    </form>
  </div>

  <!-- Halaman Absen (default hidden) -->
  <main class="container" id="absenPage" style="display:none;">
    <form id="absenForm">
      <input type="text" id="noInduk" placeholder="üÜî No Induk" readonly />
      <button type="button" id="btnMasuk">‚úÖ Absen Masuk</button>
      <button type="button" id="btnPulang" class="danger">‚èπÔ∏è Absen Pulang</button>
    </form>

    <div id="cameraContainer">
      <video id="video" autoplay playsinline></video>
    </div>

    <div class="riwayat">
      <h3>üìã Riwayat Absen</h3>
      <div id="riwayatList">Memuat data...</div>
    </div>

    <div class="chat">
      <h3>üí¨ Kirim Pesan ke IT</h3>
      <textarea id="chatPesan" placeholder="Tulis kendala atau pesan Anda di sini..."></textarea>
      <button id="kirimChat">üì® Kirim</button>
    </div>

    <button id="btnLogout">üö™ Logout</button>
  </main>

  <!-- Halaman Admin (untuk user IT001) -->
  <main class="admin-container" id="adminPage" style="display:none;">
    <h2>Admin Panel</h2>

    <div class="admin-section">
      <h3>üë• Manajemen User</h3>
      <div id="userList">Memuat data pengguna...</div>
      <form id="addUserForm">
        <h4>Tambah User Baru</h4>
        <input type="text" id="newUsername" placeholder="Username" required />
        <input type="password" id="newPassword" placeholder="Password" required />
        <input type="text" id="newNoInduk" placeholder="No Induk" required />
        <button type="submit">Tambah User</button>
      </form>
    </div>

    <div class="admin-section">
      <h3>üîÑ Reset Password User</h3>
      <form id="resetPassForm">
        <select id="selectUserReset" required>
          <option value="" disabled selected>Pilih user</option>
        </select>
        <input type="password" id="resetPassword" placeholder="Password baru" required />
        <button type="submit">Reset Password</button>
      </form>
    </div>

    <button id="btnLogoutAdmin">üö™ Logout Admin</button>
  </main>

  <footer>¬©AYIP'S 2025</footer>

<script>
  // Data user login simulasi: username, password, noInduk
  let users = JSON.parse(localStorage.getItem('users')) || [
    {username: 'IT001', password: 'admin123', noInduk: 'IT001'}, // admin
    {username: 'user01', password: 'pass01', noInduk: '001'},
    {username: 'user02', password: 'pass02', noInduk: '002'}
  ];

  // Simpan user list ke localStorage
  function saveUsers() {
    localStorage.setItem('users', JSON.stringify(users));
  }

  // Session user saat login
  let currentUser = JSON.parse(sessionStorage.getItem('currentUser')) || null;

  // Elemen DOM
  const loginPage = document.getElementById('loginPage');
  const absenPage = document.getElementById('absenPage');
  const adminPage = document.getElementById('adminPage');
  const liveDateTime = document.getElementById('liveDateTime');
  const usernameInput = document.getElementById('username');
  const userpassInput = document.getElementById('userpass');
  const noIndukInput = document.getElementById('noInduk');
  const riwayatList = document.getElementById('riwayatList');
  const chatPesan = document.getElementById('chatPesan');
  const userList = document.getElementById('userList');
  const addUserForm = document.getElementById('addUserForm');
  const resetPassForm = document.getElementById('resetPassForm');
  const selectUserReset = document.getElementById('selectUserReset');

  // Tombol
  const btnMasuk = document.getElementById('btnMasuk');
  const btnPulang = document.getElementById('btnPulang');
  const btnLogout = document.getElementById('btnLogout');
  const btnLogoutAdmin = document.getElementById('btnLogoutAdmin');
  const kirimChat = document.getElementById('kirimChat');

  // Kamera
  const video = document.getElementById('video');
  let stream;

  // Fungsi untuk update tanggal dan waktu live
  function updateDateTime() {
    const now = new Date();
    const options = {weekday:'long', year:'numeric', month:'long', day:'numeric'};
    let dateStr = now.toLocaleDateString('id-ID', options);
    let timeStr = now.toLocaleTimeString('id-ID');
    liveDateTime.textContent = dateStr + ' | ' + timeStr;
  }

  setInterval(updateDateTime, 1000);
  updateDateTime();

  // Render riwayat absen user saat ini
  function renderRiwayat() {
    let absens = JSON.parse(localStorage.getItem('absens')) || [];
    if (!currentUser) {
      riwayatList.textContent = 'Silakan login terlebih dahulu.';
      return;
    }
    let userAbsens = absens.filter(a => a.noInduk === currentUser.noInduk);
    if (userAbsens.length === 0) {
      riwayatList.textContent = 'Belum ada data absen.';
      return;
    }
    riwayatList.innerHTML = '';
    userAbsens.forEach(a => {
      const div = document.createElement('div');
      div.className = 'riwayat-item';
      div.textContent = `${a.tanggal} - Masuk: ${a.masuk || '-'} | Pulang: ${a.pulang || '-'}`;
      riwayatList.appendChild(div);
    });
  }

  // Render daftar user di admin panel
  function renderUserList() {
    userList.innerHTML = '';
    users.forEach(u => {
      const div = document.createElement('div');
      div.className = 'user-item';
      div.textContent = `${u.username} (No Induk: ${u.noInduk})`;
      // tombol hapus user kecuali admin IT001
      if (u.username !== 'IT001') {
        const btnDel = document.createElement('button');
        btnDel.textContent = 'Hapus';
        btnDel.className = 'danger';
        btnDel.addEventListener('click', () => {
          if (confirm(`Hapus user ${u.username}?`)) {
            users = users.filter(user => user.username !== u.username);
            saveUsers();
            renderUserList();
            populateUserSelect();
          }
        });
        div.appendChild(btnDel);
      }
      userList.appendChild(div);
    });
  }

  // Isi dropdown untuk reset password
  function populateUserSelect() {
    selectUserReset.innerHTML = '<option value="" disabled selected>Pilih user</option>';
    users.forEach(u => {
      if(u.username !== 'IT001') {
        const opt = document.createElement('option');
        opt.value = u.username;
        opt.textContent = u.username;
        selectUserReset.appendChild(opt);
      }
    });
  }

  // Inisialisasi tampilan sesuai user login
  function showPageForUser() {
    if (!currentUser) {
      loginPage.style.display = 'block';
      absenPage.style.display = 'none';
      adminPage.style.display = 'none';
      return;
    }

    loginPage.style.display = 'none';

    if(currentUser.username === 'IT001'){
      adminPage.style.display = 'block';
      absenPage.style.display = 'none';
      renderUserList();
      populateUserSelect();
    } else {
      adminPage.style.display = 'none';
      absenPage.style.display = 'block';
      noIndukInput.value = currentUser.noInduk;
      renderRiwayat();
      startCamera();
    }
  }

  // Login handler
  document.getElementById('loginForm').addEventListener('submit', e => {
    e.preventDefault();
    const uname = usernameInput.value.trim();
    const pass = userpassInput.value.trim();
    const user = users.find(u => u.username === uname && u.password === pass);
    if(user){
      currentUser = user;
      sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
      usernameInput.value = '';
      userpassInput.value = '';
      showPageForUser();
      alert(`Selamat datang, ${user.username}!`);
    } else {
      alert('Username atau password salah!');
    }
  });

  // Logout handler (user biasa)
  btnLogout.addEventListener('click', () => {
    if(confirm('Anda yakin ingin logout?')){
      currentUser = null;
      sessionStorage.removeItem('currentUser');
      stopCamera();
      showPageForUser();
    }
  });

  // Logout handler admin
  btnLogoutAdmin.addEventListener('click', () => {
    if(confirm('Anda yakin ingin logout?')){
      currentUser = null;
      sessionStorage.removeItem('currentUser');
      showPageForUser();
    }
  });

  // Absen masuk
  btnMasuk.addEventListener('click', () => {
    if(!currentUser){
      alert('Silakan login terlebih dahulu!');
      return;
    }
    const now = new Date();
    const tanggal = now.toLocaleDateString('id-ID');
    const jam = now.toLocaleTimeString('id-ID');

    let absens = JSON.parse(localStorage.getItem('absens')) || [];
    let todayAbsen = absens.find(a => a.noInduk === currentUser.noInduk && a.tanggal === tanggal);

    if(todayAbsen && todayAbsen.masuk){
      alert('Anda sudah absen masuk hari ini.');
      return;
    }

    if(!todayAbsen){
      todayAbsen = {noInduk: currentUser.noInduk, tanggal, masuk: jam, pulang: ''};
      absens.push(todayAbsen);
    } else {
      todayAbsen.masuk = jam;
    }

    localStorage.setItem('absens', JSON.stringify(absens));
    alert('Absen masuk berhasil! Semangat bekerja dan utamakan keselamatan');
    renderRiwayat();
  });

  // Absen pulang
  btnPulang.addEventListener('click', () => {
    if(!currentUser){
      alert('Silakan login terlebih dahulu!');
      return;
    }
    const now = new Date();
    const tanggal = now.toLocaleDateString('id-ID');
    const jam = now.toLocaleTimeString('id-ID');

    let absens = JSON.parse(localStorage.getItem('absens')) || [];
    let todayAbsen = absens.find(a => a.noInduk === currentUser.noInduk && a.tanggal === tanggal);

    if(!todayAbsen || !todayAbsen.masuk){
      alert('Anda belum melakukan absen masuk hari ini!');
      return;
    }
    if(todayAbsen.pulang){
      alert('Anda sudah absen pulang hari ini.');
      return;
    }

    todayAbsen.pulang = jam;
    localStorage.setItem('absens', JSON.stringify(absens));
    alert('Absen pulang berhasil! Selamat beristirahat üòä');
    renderRiwayat();
  });

  // Kirim chat pesan ke IT (simulasi)
  kirimChat.addEventListener('click', () => {
    if(!currentUser){
      alert('Silakan login terlebih dahulu!');
      return;
    }
    const pesan = chatPesan.value.trim();
    if(!pesan){
      alert('Isi pesan terlebih dahulu!');
      return;
    }
    let chats = JSON.parse(localStorage.getItem('chats')) || [];
    const now = new Date();
    chats.push({
      username: currentUser.username,
      noInduk: currentUser.noInduk,
      pesan,
      waktu: now.toLocaleString('id-ID')
    });
    localStorage.setItem('chats', JSON.stringify(chats));
    alert('Pesan terkirim ke IT!');
    chatPesan.value = '';
  });

  // Tambah user baru (admin)
  addUserForm.addEventListener('submit', e => {
    e.preventDefault();
    const newUser = {
      username: document.getElementById('newUsername').value.trim(),
      password: document.getElementById('newPassword').value.trim(),
      noInduk: document.getElementById('newNoInduk').value.trim()
    };
    if(users.some(u => u.username === newUser.username)){
      alert('Username sudah ada!');
      return;
    }
    users.push(newUser);
    saveUsers();
    alert(`User ${newUser.username} berhasil ditambahkan!`);
    addUserForm.reset();
    renderUserList();
    populateUserSelect();
  });

  // Reset password user (admin)
  resetPassForm.addEventListener('submit', e => {
    e.preventDefault();
    const selectedUser = selectUserReset.value;
    const newPass = document.getElementById('resetPassword').value.trim();
    if(!selectedUser || !newPass){
      alert('Lengkapi data!');
      return;
    }
    let user = users.find(u => u.username === selectedUser);
    if(user){
      user.password = newPass;
      saveUsers();
      alert(`Password user ${selectedUser} berhasil di-reset!`);
      resetPassForm.reset();
    }
  });

  // Kamera
  async function startCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('Kamera tidak didukung pada browser ini.');
      return;
    }
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
      video.srcObject = stream;
      video.style.transform = 'scaleX(1)'; // normal (no mirror)
    } catch (err) {
      alert('Tidak dapat mengakses kamera: ' + err.message);
    }
  }
  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
    video.srcObject = null;
  }

  // Init
  showPageForUser();
</script>

</body>
</html>
