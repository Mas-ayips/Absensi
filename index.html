<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absen AF PRODUCTIONS</title>
  <style>
    :root {
      --primary: #0d6efd;
      --danger: #dc3545;
      --gray: #f8f9fa;
      --dark: #212529;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--gray);
      margin: 0;
      padding: 0;
    }

    header {
      background: var(--primary);
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
    }

    .live-time {
      text-align: center;
      padding: 0.5rem;
      background: #fff;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .container {
      max-width: 600px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.05);
    }

    button {
      padding: 0.75rem;
      margin-top: 1rem;
      width: 100%;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      color: white;
    }

    #btnMasuk {
      background-color: var(--primary);
    }

    #btnPulang {
      background-color: var(--danger);
    }

    video {
      width: 100%;
      border-radius: 10px;
      margin-top: 1rem;
    }

    canvas {
      display: none;
    }

    .riwayat-item {
      background: var(--gray);
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-left: 4px solid var(--primary);
      font-size: 0.9rem;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<header>ABSEN AF PRODUCTIONS</header>
<div class="live-time" id="liveTime"></div>

<div class="container">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
  <button id="btnMasuk">‚úÖ Absen Masuk</button>
  <button id="btnPulang">‚èπÔ∏è Absen Pulang</button>

  <div id="riwayat"></div>
</div>

<script>
  const apiUrl = "https://script.google.com/macros/s/AKfycbxIt5rLjpI9hreKfaa6YtolBaGAHQwD06oxKb0NllISpksNW_sXtGshLI3pJykJtTXr/exec";
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  let user = localStorage.getItem('noInduk');
  let pass = localStorage.getItem('password');
  if (!user || !pass) window.location.href = "login.html";

  // Live Time
  setInterval(() => {
    const now = new Date();
    document.getElementById('liveTime').textContent = now.toLocaleString();
  }, 1000);

  // Kamera
  navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    video.srcObject = stream;
  });

  document.getElementById("btnMasuk").addEventListener("click", () => absen("masuk"));
  document.getElementById("btnPulang").addEventListener("click", () => absen("pulang"));

  function absen(tipe) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      // Tangkap selfie dari video
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const selfieData = canvas.toDataURL("image/jpeg");

      const data = {
        type: "absen",
        user,
        pass,
        tipe,
        lat,
        lng,
        selfie: selfieData
      };

      fetch(apiUrl, {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.json())
      .then(resp => {
        if (resp.status === "success") {
          alert(tipe === "masuk" ? "‚úÖ Selamat bekerja!" : "‚úÖ Terima kasih, sampai jumpa!");
          tampilkanRiwayat();
        } else {
          alert("‚ùå Gagal absen: " + resp.message);
        }
      })
      .catch(() => alert("Gagal mengirim data."));
    }, () => {
      alert("Aktifkan GPS untuk melanjutkan.");
    });
  }

  function tampilkanRiwayat() {
    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        const box = document.getElementById("riwayat");
        box.innerHTML = "<h3>üìã Riwayat Absen:</h3>";
        data.reverse().forEach(r => {
          if (r.user === user) {
            box.innerHTML += `<div class="riwayat-item">[${new Date(r.waktu).toLocaleString()}] ${r.tipe.toUpperCase()} - Lokasi: ${r.lat}, ${r.lng}</div>`;
          }
        });
      });
  }

  tampilkanRiwayat();
</script>

</body>
</html>
